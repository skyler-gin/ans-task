<!DOCTYPE html>
<html>
<head>
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-canvas-keyboard-response.js"></script>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />

  <style>
    body { background: white; }
    #stop-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      font-size: 16px;
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: none;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>
  <button id="stop-button">Stop Task</button>

<script>
/* =======================
   REQUIRED LINKS (EDITED)
   ======================= */
const DATA_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbw13aJQQSF-uMwviOHrDCFGkPd57qozYNkiPTDNB5m9EmrmP3EvNK7PGNhQCGNwhxkx/exec";

const QUALTRICS_RETURN_URL =
  "https://brown.co1.qualtrics.com/jfe/form/SV_9KPQJgVkpEZkhN4";

/* =======================
   PID FROM QUALTRICS
   ======================= */
const params = new URLSearchParams(window.location.search);
const pid = params.get("pid") || "NO_PID";

/* =======================
   TASK PARAMETERS
   ======================= */
const taskDurationMinutes = 5;
const taskEndTime = Date.now() + taskDurationMinutes * 60 * 1000;
const responseKeys = ['f','j'];

let attempted = 0;
let correct = 0;

/* =======================
   SEND DATA TO GOOGLE
   ======================= */
function sendTrialData(data) {
  fetch(DATA_ENDPOINT, {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  });
}

/* =======================
   jsPsych SETUP
   ======================= */
jsPsych.data.addProperties({ pid });

const timeline = [];

/* -------- Instructions -------- */
timeline.push({
  type: "html-keyboard-response",
  stimulus: `
    <h3>Number Task</h3>
    <p>Two groups of dots will appear briefly.</p>
    <p>Press <strong>F</strong> if the LEFT side has more dots.</p>
    <p>Press <strong>J</strong> if the RIGHT side has more dots.</p>
    <p>You may stop at any time using the red button.</p>
    <p><em>Press any key to begin.</em></p>
  `
});

/* -------- Trial Loop -------- */
const trialLoop = {
  timeline: [{
    type: "html-keyboard-response",
    stimulus: () => {
      const left = Math.floor(Math.random() * 20) + 5;
      const right = Math.floor(Math.random() * 20) + 5;
      jsPsych.data.addProperties({ left, right });
      return `<p style="font-size:40px">LEFT: ${left} &nbsp;&nbsp; RIGHT: ${right}</p>`;
    },
    choices: responseKeys,
    on_finish: data => {
      attempted++;
      const left = jsPsych.data.getLastTrialData().values()[0].left;
      const right = jsPsych.data.getLastTrialData().values()[0].right;
      const isCorrect =
        (left > right && data.response === 'f') ||
        (right > left && data.response === 'j');

      if (isCorrect) correct++;

      sendTrialData({
        pid,
        left,
        right,
        response: data.response,
        accuracy: isCorrect ? 1 : 0,
        timestamp: Date.now()
      });
    }
  }],
  loop_function: () => Date.now() < taskEndTime
};

timeline.push(trialLoop);

/* -------- End + Redirect -------- */
timeline.push({
  type: "html-keyboard-response",
  stimulus: "<p>Task complete. Returning to surveyâ€¦</p>",
  on_start: () => {
    const engagement = correct;
    const persistence = attempted > 0 ? correct / attempted : 0;

    const url =
      QUALTRICS_RETURN_URL +
      "?ans_done=1" +
      "&pid=" + encodeURIComponent(pid) +
      "&attempted=" + attempted +
      "&correct=" + correct +
      "&engagement=" + engagement +
      "&persistence=" + persistence;

    window.location.href = url;
  }
});

/* -------- INIT -------- */
jsPsych.init({ timeline });

document.getElementById("stop-button").style.display = "block";
document.getElementById("stop-button").onclick = () => {
  const engagement = correct;
  const persistence = attempted > 0 ? correct / attempted : 0;

  window.location.href =
    QUALTRICS_RETURN_URL +
    "?ans_done=0" +
    "&pid=" + encodeURIComponent(pid) +
    "&attempted=" + attempted +
    "&correct=" + correct +
    "&engagement=" + engagement +
    "&persistence=" + persistence;
};
</script>
</body>
</html>
